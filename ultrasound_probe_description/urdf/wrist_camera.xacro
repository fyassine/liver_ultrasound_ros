<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro">
  <!-- Wrist camera module: attach an RGB camera to a specified parent link via fixed joint -->
  <xacro:macro name="wrist_camera" params="parent_link:=iiwa_link_ee robot_name:=iiwa camera_name:=wrist_camera xyz:='0 0 0.08' rpy:='0 0 0' width:=640 height:=480 hfov:=1.047 rate:=30">

    <!-- Camera link -->
    <link name="${camera_name}_link">
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <box size="0.03 0.03 0.03"/>
        </geometry>
        <material name="Blue"/>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <box size="0.03 0.03 0.03"/>
        </geometry>
      </collision>
      <inertial>
        <mass value="0.05"/>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <inertia ixx="1e-4" ixy="0" ixz="0" iyy="1e-4" iyz="0" izz="1e-4"/>
      </inertial>
    </link>

    <!-- Fixed joint to the chosen parent (wrist or flange) -->
    <joint name="${camera_name}_mount_joint" type="fixed">
      <parent link="${parent_link}"/>
      <child link="${camera_name}_link"/>
      <origin xyz="${xyz}" rpy="${rpy}"/>
    </joint>

    <!-- Optical frame child (REP-103: +Z forward, +X right, +Y down) -->
    <link name="${camera_name}_optical_frame"/>
    <joint name="${camera_name}_optical_joint" type="fixed">
      <parent link="${camera_name}_link"/>
      <child link="${camera_name}_optical_frame"/>
      <!-- rotate camera_link (+X forward, +Z up) to optical (+Z forward, +X right, +Y down) -->
      <origin xyz="0 0 0" rpy="0 -1.57079632679 -1.57079632679"/>
    </joint>

    <!-- Gazebo sensor and ROS plugin (RGB-D depth camera) -->
    <gazebo reference="${camera_name}_link">
      <sensor name="${camera_name}_sensor" type="depth">
        <update_rate>${rate}</update_rate>
        <camera>
          <horizontal_fov>${hfov}</horizontal_fov>
          <image>
            <width>${width}</width>
            <height>${height}</height>
            <format>R8G8B8</format>
          </image>
          <clip>
            <near>0.05</near>
            <far>10.0</far>
          </clip>
        </camera>
        <plugin name="${camera_name}_controller" filename="libgazebo_ros_openni_kinect.so">
          <robotNamespace>/${robot_name}</robotNamespace>
          <alwaysOn>true</alwaysOn>
          <updateRate>${rate}</updateRate>
          <cameraName>${camera_name}</cameraName>
          <imageTopicName>rgb/image_raw</imageTopicName>
          <cameraInfoTopicName>rgb/camera_info</cameraInfoTopicName>
          <depthImageTopicName>depth/image_raw</depthImageTopicName>
          <depthImageCameraInfoTopicName>depth/camera_info</depthImageCameraInfoTopicName>
          <pointCloudTopicName>depth/points</pointCloudTopicName>
          <frameName>${camera_name}_optical_frame</frameName>
        </plugin>
      </sensor>
    </gazebo>

  </xacro:macro>
</robot>
