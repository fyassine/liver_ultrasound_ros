<?xml version="1.0"?>
<launch>
  <!-- =========================================================
       Combined EIH & EOB Launch for IIWA + Azure Kinect
       - Enable one or both cameras via args.
       - Uses namespaces/tf_prefix to allow dual-camera operation.
       ========================================================= -->

  <!-- GLOBAL TOGGLES -->
  <arg name="enable_eih" default="true" doc="Enable Eye-in-Hand Camera and Calibration"/>
  <arg name="enable_eob" default="false" doc="Enable Eye-on-Base Camera and Calibration"/>

  <!-- SERIAL NUMBERS (Required if running both cameras at once) -->
  <arg name="eih_serial_no" default="000188401612" doc="Serial # for Hand camera (empty = first found)"/>
  <arg name="eob_serial_no" default="000187504512" doc="Serial # for Base camera (empty = first found)"/>

  <!-- CALIBRATION NAMES (Must match your saved files) -->
  <arg name="eih_calib_name" default="my_eih_calib"/>
  <arg name="eob_calib_name" default="my_eob_calib"/>

  <!-- ROBOT CONFIGURATION -->
  <arg name="robot_name" default="iiwa"/>
  <arg name="model" default="iiwa7"/>
  <arg name="hardware_interface" default="PositionJointInterface"/>
  <arg name="robot_base_frame" default="iiwa_link_0"/>
  <arg name="robot_effector_frame" default="iiwa_link_ee"/>

  <!-- CAMERA SETTINGS -->
  <arg name="depth_mode" default="NFOV_2X2BINNED"/>
  <arg name="color_resolution" default="720P"/> <!-- Try 720P or 360P -->
  <arg name="fps" default="5"/>

  <!-- ARUCO SETTINGS -->
  <arg name="marker_id" default="582"/>
  <arg name="marker_size" default="0.083"/>

  <!-- WORLD TRANSFORM -->
  <arg name="world_frame" default="world"/>
  <arg name="publish_world_tf" default="true"/>
  <arg name="world_to_robot_xyz" default="0 0 0"/>
  <arg name="world_to_robot_rpy" default="0 0 0"/>


  <!-- =========================================================
       1. SHARED RESOURCES (Robot, MoveIt, World TF)
       ========================================================= -->
  
  <!-- Start Robot + MoveIt -->
  <include file="$(find iiwa_moveit)/launch/moveit_planning_execution.launch">
    <arg name="sim" value="false"/>
    <arg name="rviz" value="true"/>
    <arg name="hardware_interface" value="$(arg hardware_interface)"/>
    <arg name="robot_name" value="$(arg robot_name)"/>
    <arg name="model" value="$(arg model)"/>
  </include>

  <!-- World -> Robot Transform -->
  <group if="$(arg publish_world_tf)">
    <node name="world_to_robot_base" pkg="tf" type="static_transform_publisher"
          args="$(arg world_to_robot_xyz) $(arg world_to_robot_rpy) $(arg world_frame) $(arg robot_base_frame) 30"/>
  </group>

  <!-- Joint State Relay (for Visualization) -->
  <node name="joint_state_relay" pkg="topic_tools" type="relay" args="/iiwa/joint_states /joint_states" respawn="true"/>


  <!-- =========================================================
       2. EYE-IN-HAND (EIH) CONFIGURATION
       ========================================================= -->
  <group if="$(arg enable_eih)" ns="hand_camera">
    
    <!-- Unique TF Prefixes prevent frame collisions -->
    <arg name="tf_prefix" value="hand_camera_" />
    <arg name="camera_base_frame" value="$(arg tf_prefix)camera_base" />
    <arg name="camera_rgb_frame" value="$(arg tf_prefix)rgb_camera_link" />

    <!-- Azure Kinect Driver -->
    <include file="$(find azure_kinect_ros_driver)/launch/driver.launch">
      <arg name="tf_prefix" value="$(arg tf_prefix)"/>
      <arg name="sensor_sn" value="$(arg eih_serial_no)"/>
      <arg name="depth_mode" value="$(arg depth_mode)"/>
      <arg name="color_resolution" value="$(arg color_resolution)"/>
      <arg name="fps" value="$(arg fps)"/>
      <!-- IMPORTANT: Prevent driver from trying to overwrite the Robot's description -->
      <arg name="overwrite_robot_description" value="false" />
    </include>

    <!-- ArUco Tracking -->
    <node pkg="aruco_ros" type="single" name="aruco_single">
      <!-- Remap to local namespace topics -->
      <remap from="image" to="rgb/image_raw"/>
      <remap from="camera_info" to="rgb/camera_info"/>
      <param name="image_is_rectified" value="true"/>
      <param name="marker_size" value="$(arg marker_size)"/>
      <param name="marker_id" value="$(arg marker_id)"/>
      <param name="reference_frame" value="$(arg camera_base_frame)"/>
      <param name="camera_frame" value="$(arg camera_rgb_frame)"/>
      <param name="marker_frame" value="hand_aruco_marker_frame"/>
    </node>

    <!-- Calibration Publisher (TF: Robot Flange -> Camera Base) -->
    <include file="$(find easy_handeye)/launch/publish.launch">
      <arg name="namespace_prefix" value="$(arg eih_calib_name)"/>
      <arg name="eye_on_hand" value="true"/>
      <arg name="robot_effector_frame" value="$(arg robot_effector_frame)"/>
      <arg name="tracking_base_frame" value="$(arg camera_base_frame)"/>
    </include>
  </group>


  <!-- =========================================================
       3. EYE-ON-BASE (EOB) CONFIGURATION
       ========================================================= -->
  <group if="$(arg enable_eob)" ns="base_camera">
    
    <!-- Unique TF Prefixes -->
    <arg name="tf_prefix" value="base_camera_" />
    <arg name="camera_base_frame" value="$(arg tf_prefix)camera_base" />
    <arg name="camera_rgb_frame" value="$(arg tf_prefix)rgb_camera_link" />

    <!-- Azure Kinect Driver -->
    <include file="$(find azure_kinect_ros_driver)/launch/driver.launch">
      <!-- Add delay to second camera to staggering USB startup surge -->
      <!-- <arg name="launch_prefix" value="bash -c 'sleep 5; $0 $@' " /> -->
      <arg name="tf_prefix" value="$(arg tf_prefix)"/>
      <arg name="sensor_sn" value="$(arg eob_serial_no)"/>
      <arg name="depth_mode" value="$(arg depth_mode)"/>
      <arg name="color_resolution" value="$(arg color_resolution)"/>
      <arg name="fps" value="$(arg fps)"/>
      <arg name="overwrite_robot_description" value="false" />
    </include>

    <!-- ArUco Tracking -->
    <node pkg="aruco_ros" type="single" name="aruco_single">
      <remap from="image" to="rgb/image_raw"/>
      <remap from="camera_info" to="rgb/camera_info"/>
      <param name="image_is_rectified" value="true"/>
      <param name="marker_size" value="$(arg marker_size)"/>
      <param name="marker_id" value="$(arg marker_id)"/>
      <param name="reference_frame" value="$(arg camera_base_frame)"/>
      <param name="camera_frame" value="$(arg camera_rgb_frame)"/>
      <param name="marker_frame" value="base_aruco_marker_frame"/>
    </node>

    <!-- Calibration Publisher (TF: Robot Base -> Camera Base) -->
    <include file="$(find easy_handeye)/launch/publish.launch">
      <arg name="namespace_prefix" value="$(arg eob_calib_name)"/>
      <arg name="eye_on_hand" value="false"/>
      <arg name="robot_base_frame" value="$(arg robot_base_frame)"/>
      <arg name="tracking_base_frame" value="$(arg camera_base_frame)"/>
    </include>
  </group>

</launch>